# Makefile for Horse å‘ç”Ÿ Server
# ä½¿ç”¨: make <command>

.PHONY: help install build start dev stop restart logs clean deploy docker-up docker-down

# é»˜è®¤ç›®æ ‡
help:
	@echo "Horse å‘ç”Ÿ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  make install      - å®‰è£…æ‰€æœ‰ä¾èµ–"
	@echo "  make build        - æ„å»ºå‰ç«¯"
	@echo "  make start        - å¯åŠ¨æœåŠ¡å™¨"
	@echo "  make dev          - å¼€å‘æ¨¡å¼å¯åŠ¨"
	@echo "  make stop         - åœæ­¢æœåŠ¡å™¨"
	@echo "  make restart      - é‡å¯æœåŠ¡å™¨"
	@echo "  make logs         - æŸ¥çœ‹æ—¥å¿—"
	@echo "  make clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make deploy       - å®Œæ•´éƒ¨ç½²"
	@echo "  make docker-up    - Docker å¯åŠ¨"
	@echo "  make docker-down  - Docker åœæ­¢"
	@echo ""

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…æœåŠ¡å™¨ä¾èµ–..."
	cd server && npm install
	@echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
	npm install
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# æ„å»ºå‰ç«¯
build:
	@echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
	npm run build
	@echo "âœ… æ„å»ºå®Œæˆ"

# å¯åŠ¨æœåŠ¡å™¨ï¼ˆPM2ï¼‰
start:
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡å™¨..."
	cd server && pm2 start ecosystem.config.json
	@echo "âœ… æœåŠ¡å™¨å·²å¯åŠ¨"

# å¼€å‘æ¨¡å¼
dev:
	@echo "ğŸ”§ å¼€å‘æ¨¡å¼å¯åŠ¨..."
	cd server && npm run dev

# åœæ­¢æœåŠ¡å™¨
stop:
	@echo "ğŸ›‘ åœæ­¢æœåŠ¡å™¨..."
	cd server && pm2 stop horse-app
	@echo "âœ… æœåŠ¡å™¨å·²åœæ­¢"

# é‡å¯æœåŠ¡å™¨
restart:
	@echo "ğŸ”„ é‡å¯æœåŠ¡å™¨..."
	cd server && pm2 restart horse-app
	@echo "âœ… æœåŠ¡å™¨å·²é‡å¯"

# æŸ¥çœ‹æ—¥å¿—
logs:
	cd server && pm2 logs horse-app

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf dist
	rm -rf server/node_modules
	rm -rf server/logs/*.log
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®Œæ•´éƒ¨ç½²
deploy: install build
	@echo "ğŸš€ éƒ¨ç½²åº”ç”¨..."
	cd server && pm2 delete horse-app || true
	cd server && pm2 start ecosystem.config.json
	cd server && pm2 save
	@echo "âœ… éƒ¨ç½²å®Œæˆ"

# Docker å¯åŠ¨
docker-up:
	@echo "ğŸ³ Docker å¯åŠ¨..."
	docker-compose up -d
	@echo "âœ… Docker å·²å¯åŠ¨"

# Docker åœæ­¢
docker-down:
	@echo "ğŸ³ Docker åœæ­¢..."
	docker-compose down
	@echo "âœ… Docker å·²åœæ­¢"

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ’š å¥åº·æ£€æŸ¥..."
	@curl -f http://localhost:3000/health || echo "âŒ æœåŠ¡å™¨æœªå“åº”"

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡å™¨çŠ¶æ€:"
	cd server && pm2 status
